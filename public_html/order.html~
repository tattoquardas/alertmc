<!DOCTYPE html>

<html>
    <head>
        <link rel="stylesheet" href="Styles/styles.css">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>

	<script src="Scripts/index.js"></script>

	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Josefin+Slab">
        <meta charset="UTF-8" name="viewport" content="maximum-scale=1.0">
        <title>Make an order</title>
    </head>
    <body ng-app="orderApp" ng-controller="orderController">
        <div class="page-wrap">
            <div id="headSect"></div>
                <br>
            <div class="pageheader">
                MAKE AN ORDER HERE!
            </div>
            <div class="mission-text" style="text-align: center;">
                <div class="comm" id="comment_form">
                    <div>
                        <input type="email" name="email" id="email" value="" placeholder="Email" ng-model="email" required> 
                        <input type="text" name="name" id="f_name" value="" placeholder="First Name" ng-model="firstName" required>
                        <input type="text" name="lastname" id="l_name" value="" placeholder="Last Name" ng-model="lastName" required>             
                    </div>
                    <br>
                    <div>
                        <input type="text" name="org_name" id="org_name" value="" placeholder="Name of organization" ng-model="org">
                        <input type="number" name="phone" id="phone" value="" placeholder="Phone number" ng-model="phone">
                        <input type="text" name="country" id="country" value="" placeholder="Country" ng-model="country"> 
                    </div>
                    <br>
                    <div> 
                        <input type="text" name="address" id="addr" value="" placeholder="Invoice address" style="width: 77%;" ng-model="addressInvoice">
                    </div>
                    <br>
                    <div> 
                        <input type="text" name="address" id="addr" value="" placeholder="Delivery address" style="width: 77%;" ng-model="addressDelivery">
                    </div>
                    <br>
                    <div>
                        <textarea rows="3" name="comment" id="comment" placeholder="Comment" style="width: 77%;" ng-model="comment"></textarea>
                    </div>
                    <div class="container-fluid">
                        <div class="report_al">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr ng-repeat="item in records">
                                        <td  class="col-md-4">
                                            <div class="imag" id="{{item.bookId}}"><c><a href="BookPages/led_pages.html"><img src={{item.imag}} style="width: 35%;"/></a></c></div>
                                        </td>
                                        <td>
                                            Name: {{item.bookName}}
                                            <br>Language: {{item.langLabel}}
                                            <br>Quantity: {{item.quant}}
					    <span class="glyphicon glyphicon-plus" ng-click="item.quant = item.quant + 1; refreshOverallPrice();" style="cursor:pointer;"></span>
					    <span class="glyphicon glyphicon-minus" ng-click="item.quant > 1 ?item.quant = item.quant - 1:item.quant = 1; refreshOverallPrice()" style="cursor:pointer;"></span>
					    <span class="glyphicon glyphicon-trash" ng-click="deleteItemFromOrder(item);" style="cursor:pointer;"></span>
                                            <br><b>Price: {{item.price}} Euro</b>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td  class="col-md-4" style="text-align: center;">
                                                <br>
                                                <b>TOTAL PRICE:</b> 
                                        </td>
                                        <td>
                                            <br>
                                            <b style="color: green; font-size: 30px">{{overallPrice}} EURO</b>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <br>
                    <div>
                        <c><input type="submit" name="submit" value="Order" ng-click="makeOrder();"></c>
                    </div>
                </div>
            </div>
        </div>
        <script>
		var app = angular.module("orderApp", []);
		app.controller("orderController", function($scope, $http){
			$scope.hostURL = 'http://localhost:3000/';
			$scope.subscribe = true;
			$scope.records = [];
			$scope.overallPrice = 0;
			$scope.getParam = function(name, url){
				if (!url)
					url = window.location.href;
				name = name.replace(/[\[\]]/g, "\\$&");
				var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
			        results = regex.exec(url);
				if (!results)
					return null;
				if (!results[2])
					return '';
				return decodeURIComponent(results[2].replace(/\+/g, " "));
			}

			$scope.generateTableWithBooks = function(){
				var numberOfBooks = $scope.getParam("books");
				var no = 1;
				for(var i=0;i<numberOfBooks;){
					var bookId = $scope.getParam("bookId" + no);
					var lang = $scope.getParam("lang" + no);
					var quant = parseInt($scope.getParam("quant" + no));
					++no;
					i+=quant;
					$scope.records.push({"bookId": bookId, "lang": lang, "quant": quant});
					for(var j=0; j<$scope.data.length; ++j){
						if($scope.data[j].bookId === bookId){
							$scope.records[$scope.records.length-1]["bookName"] = $scope.data[j]["bookTitle"];
							$scope.records[$scope.records.length-1]["price"] = $scope.data[j]["price"];
							$scope.records[$scope.records.length-1]["imag"] = $scope.data[j]["bookDiffLangImages"][lang];
							for(var k=0; k<$scope.data[j].langOptions.length; ++k){
								if($scope.data[j].langOptions[k].value === lang)
									$scope.records[$scope.records.length-1]["langLabel"] = $scope.data[j].langOptions[k].label;
							}
							$scope.overallPrice += $scope.records[$scope.records.length-1]["price"] * quant;
						}
					}
				}
			}
			$http.get($scope.hostURL + "getPublications").then(function(response){
					$scope.data = response.data;
					$scope.generateTableWithBooks();
			});
			$scope.refreshOverallPrice = function(){
				$scope.overallPrice = 0;
				for(var i = 0; i<$scope.records.length; ++i)
					$scope.overallPrice += $scope.records[i]["price"] * $scope.records[i]["quant"];
			}
			$scope.deleteItemFromOrder = function(item){
				var i = 0;
				while(item != $scope.records[i])
					++i;
				$scope.records.splice(i,1);
				$scope.refreshOverallPrice();
			}
			$scope.makeOrder = function(){
				var order	=	{
								"email" : $scope.email,
								"firstName" : $scope.firstName,
								"lastName" : $scope.lastName,
								"org" : $scope.org,
								"phone" : $scope.phone,
								"country" : $scope.country,
								"addressInvoice" : $scope.addressInvoice,
								"addressDelivery" : $scope.addressDelivery,
								"comment" : $scope.comment,
								"books" : $scope.records,
								"overallPrice" : $scope.overallPrice,
								"subscribe" : $scope.subscribe
							}
				$http.post($scope.hostURL + "DataForOrder", order);
			}
		});
	</script>
        <footer id="footer">
            <p>&#169 1991 - 2016 Alert Managment Consultants</p>
        </footer>
    </body>
</html>

